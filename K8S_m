#!/bin/bash
# K8S Installer Script (Master / Worker)
# Tested on Ubuntu 20.04+

kubeconfig_path="$HOME"

function unknown_option() {
    echo -e "\nUnknown K8S node type: $1 \n"
    echo "--------------------------------------------------------------------------"
    echo "Preferred Ubuntu 20.04_LTS or above"
    echo "------------------------------ Master setup ------------------------------"
    echo "  Minimum requirement - 2GB RAM & 2 Core CPU" 
    echo "  Usage: ./k8s_install.sh master"
    echo "------------------------------ Worker setup ------------------------------"
    echo "  Minimum requirement - Any"
    echo "  Usage: ./k8s_install.sh worker"
    echo "--------------------------------------------------------------------------"
}

# Show help
[[ "$1" == "--help" || "$1" == "help" || "$1" == "-h" ]] && { unknown_option; exit 0; }

# Validate argument
if [[ "$1" == 'master' ]]; then 
    NODE_TYPE="master"
    echo -e "\n-------------------------- K8S Master node setup --------------------------"
elif [[ "$1" == 'worker' ]]; then 
    NODE_TYPE="worker"
    echo -e "\n-------------------------- K8S Worker node setup --------------------------"
else 
    unknown_option $1
    exit 1
fi

# Update OS and disable swap
echo -e "\n-------------------------- Updating OS and disabling swap --------------------------\n"
sudo apt update -y
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# Load kernel modules and sysctl
sudo tee /etc/modules-load.d/containerd.conf <<EOF
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

sudo tee /etc/sysctl.d/kubernetes.conf <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
EOF
sudo sysctl --system

# Install base packages
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release software-properties-common

# Install containerd
echo -e "\n-------------------------- Installing containerd --------------------------\n"
sudo apt install -y containerd
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containerd

# Install kubernetes packages
echo -e "\n-------------------------- Installing kubeadm, kubelet, kubectl --------------------------\n"
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update -y
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

# Optional tools
echo -e "\n-------------------------- Installing stern and kubectx --------------------------\n"
curl -s -Lo /tmp/stern.tar.gz https://github.com/stern/stern/releases/download/v1.24.0/stern_1.24.0_linux_amd64.tar.gz
tar -xvzf /tmp/stern.tar.gz -C /tmp
sudo mv /tmp/stern /usr/local/bin/
sudo apt install -y kubectx

# Master node setup
if [[ "$NODE_TYPE" == "master" ]]; then
    echo -e "\n-------------------------- Initializing K8S Master --------------------------\n"
    sudo kubeadm init --pod-network-cidr=192.168.0.0/16

    # Setup kubectl for the current user
    mkdir -p $kubeconfig_path/.kube
    sudo cp -i /etc/kubernetes/admin.conf $kubeconfig_path/.kube/config
    sudo chown $(id -u):$(id -g) $kubeconfig_path/.kube/config

    echo -e "\n-------------------------- Install Calico network plugin --------------------------\n"
    kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

    echo -e "\n-------------------------- Master node status --------------------------\n"
    kubectl get nodes
    echo -e "\nSave the kubeadm join command above to add worker nodes."
fi

# Worker node instructions
if [[ "$NODE_TYPE" == "worker" ]]; then
    echo -e "\n-------------------------- Worker Node Setup --------------------------\n"
    echo "1. Run this script with 'master' on the control-plane to get join command"
    echo "2. On worker node, execute: sudo kubeadm join <token-from-master> --discovery-token-ca-cert-hash sha256:<hash>"
    echo "3. Verify on master: kubectl get nodes"
fi
